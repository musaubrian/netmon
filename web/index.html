<!doctype html>
<html lang="en">

<head>
  <title></title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet" />
  <title>NetMon</title>
</head>

<body
  style="font-family: &quot;Varela Round&quot;, sans-serif; margin: 0; padding: 0; box-sizing: border-box; height: 100vh;">
  <div style="
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        width: 100vw;
        height: auto;
      ">
    <h1 id="h1" style="text-align: center; margin-bottom: 1rem; width: 50%"></h1>

    <canvas id="myChart" style="max-height: 70vh; height: 50vh; max-width: 90vw" aria-label="Graph of latency by time"
      role="image">
    </canvas>

    <h2 id="h2" style="text-align: center; margin-bottom: 0.5rem; font-size: 1.14rem;"></h2>
    <span style="font-size: 1.15rem;">
      Last outage
      <button id="open" style="
          background-color: transparent;
          border:0;
          padding: 0;
          text-decoration: underline;
          font-size: inherit;
        ">
        ended at
      </button>
    </span>
    <dialog style="border-radius: 20px; border: 0; background-color: #cbd5e1">
      <div style="margin-bottom: 0.5rem">
        <p style="font-size: 1.2rem; margin-bottom: 0.2rem; padding: 0.5rem">
          Internet came back up on<br>
          <span id="date" style="font-weight: 650; font-size: 1rem"> _ </span>
          at
          <span id="time" style="font-weight: 650; font-size: 1rem">_ </span>
        </p>
      </div>
      <form method="dialog" style="width: 100%; display: inline-flex; justify-content: end">
        <button style="
              background-color: green;
              border: none;
              border-radius: 15px;
              font-size: 1rem;
              padding: 0.7rem;
            ">
          Close
        </button>
      </form>
    </dialog>
  </div>
</body>
<script>
  const h1 = document.getElementById("h1");
  const h2 = document.getElementById("h2");
  const d = document.getElementById("date");
  const t = document.getElementById("time");
  const openDialogue = document.getElementById("open");
  const dialogue = document.querySelector("dialog");

  openDialogue.addEventListener("click", () => {
    dialogue.showModal();
  });

  function getLastDown() {
    return fetch("/down")
      .then((res) => res.json())
      .then((data) => {
        d.innerHTML = data.date;
        t.innerHTML = data.time;
      });
  }

  function fetchLogs() {
    return fetch("/lats")
      .then((response) => response.json())
      .then((data) => {
        let records = data.records;
        h1.innerHTML = data.day;
        h2.innerHTML = `Updated at: ${data.updated_at}`;
        let newxValues = [];
        let newyValues = [];

        let startLoopIndex = Math.max(0, records.length - 60); // Get last 60 items(minute)

        for (let i = startLoopIndex; i < records.length; i++) {
          let record = records[i];
          for (let j = 0; j < record.length; j++) {
            newxValues.push(record[j].start);
            newyValues.push(record[j].latency);
          }
        }

        // // Replace x&yValues with new values
        xValues.splice(0, xValues.length, ...newxValues);
        yValues.splice(0, yValues.length, ...newyValues);

        // Trigger chart update
        myChart.data.labels = xValues;
        myChart.data.datasets[0].data = yValues;
        myChart.update();
      })
      .catch((error) => {
        console.error("Error:", error);
      });
  }

  const xValues = [];
  const yValues = [];

  const myChart = new Chart("myChart", {
    type: "line",
    data: {
      labels: xValues,
      datasets: [
        {
          fill: false,
          lineTension: 0.25,
          pointRadius: 1,
          backgroundColor: "white",
          borderColor: "rgba(42, 29, 245, 0.8)",
          data: yValues,
        },
      ],
    },
    options: {
      title: {
        display: true,
        text: "Latency per request",
        fontSize: 22,
      },
      legend: {
        display: false,
      },
      scales: {
        xAxes: [
          {
            ticks: {display: false},
            scaleLabel: {
              display: true,
              labelString: "Requests in a minute",
            },
          },
        ],
        yAxes: [
          {
            ticks: {min: 0},
            scaleLabel: {
              display: false,
            },
          },
        ],
      },
    },
  });

  //initial fetch
  fetchLogs();
  getLastDown();

  setInterval(fetchLogs(), 60 * 1000);
  setInterval(getLastDown(), 5 * 60 * 1000);
</script>

</html>
